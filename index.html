<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>gm-rsa</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <script src="https://peterolson.github.io/BigInteger.js/BigInteger.min.js"></script>
  <script src="https://cdn.rawgit.com/zenorocha/clipboard.js/v1.5.13/dist/clipboard.min.js"></script>
  <script src="gm-rsa.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
  <style>
    .module input, .module button {
      width: 100%;
    }
    footer {
      text-align: center;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="row">
      <div class="twelve columns">
        <h3>GM-RSA Utility</h3>
        <span>
          This is a demo of the <code>gm-rsa</code> package to provide a
          simple interface for the RSA encryption algorithm.
        </span>
      </div>
    </header>
    <br>
    <div class="row">
      <div class="six columns">
        <span class="toggle"><a href="#">Receive a Message</a></span>
        <p class="info" style="display:none;">
          Give a friend your <b>Public Key</b> together with a link to this page
          so they can encrypt messages and then send them to you. Only you will
          be able to read the original message using your <b>Private Key</b>.
        </p>
      </div>
      <div class="six columns">
        <span class="toggle"><a href="#">Send a Message</a></span>
        <p class="info" style="display:none;">
          Ask for a friend's <b>Public Key</b> and put it in the appropiate
          field below. Then write any message and encrypt it and send them the
          cyher, only them can decrypt it using their <b>Private Key</b>. 
        </p>
      </div>
    </div>
    <br>
    <form class="rsa row">
      <div class="module settings one-third column">
        <h5>Key Settings</h5>

        <h6 for="ekey">Public</h6>
        <input type="text" class="ekey">

        <h6 for="dkey">Private</h6>
        <input type="text" class="dkey">

        <br><br>
        <button type="button" class="generate">Generate</button>
        <button type="button" class="share" data-clipboard-target=".settings .ekey">Share Public Key</button>
      </div>

      <div class="module encryption one-third column">
        <h5>Encryption</h5>

        <h6 for="msg">Message</h6>
        <input type="text" class="msg">

        <h6 for="cyp">Cypher</h6>
        <input type="text" class="cyp" readonly>

        <br><br>
        <button type="button" class="encrypt">Encrypt</button>
        <button type="button" class="share" data-clipboard-target=".encryption .cyp">Share Cypher</button>
      </div>

      <div class="module decryption one-third column">
        <h5>Decryption</h5>

        <h6 for="cyp">Cypher</h6>
        <input type="text" class="cyp">

        <h6 for="msg">Message</h6>
        <input type="text" class="msg" readonly>

        <br><br>
        <button type="button" class="decrypt">Decrypt</button>
        <button type="button" class="retrieve">Restore Keys</button>
      </div>
    </form>
    <footer class="row">
      <div class="twelve columns">
        <p>
          <b>Disclaimer:</b> The keys used in this demo are short, and therefore
          they are <b>not safe</b>. Please do not encrypt <i>sensible</i>
          information with this tool.
        </p>
      </div>
    </footer>
  </div>

  <script>
    $(document).ready(function(){
      var CTRL_CHAR = String.fromCharCode(0);
      var NULL_CHAR = String.fromCharCode(9216);

      var rsaProxy = {
        root: function () { return $(".rsa"); },
        module: function (mod) { return this.root().find("." + mod); },
        elem: function (mod, elem) { return this.module(mod).find("." + elem); },
      }

      // Generate
      rsaProxy.elem("settings", "generate").click(function () {
        if (confirm("This will delete the previously saved keys.")) {
          var keys = RSAUtil.generate(1000000);
          localStorage.setItem("rsa-keys", JSON.stringify(keys));

          rsaProxy.elem("settings", "ekey").val(JSON.stringify(keys.e));
          rsaProxy.elem("settings", "dkey").val(JSON.stringify(keys.d));
        }
      });

      // Encryption
      rsaProxy.elem("encryption", "encrypt").click(function () {
        var key = JSON.parse(rsaProxy.elem("settings", "ekey").val());
        var msg = rsaProxy.elem("encryption", "msg").val();
        var cyp = RSAUtil.encrypt(key,msg);
        cyp = cyp.replace(CTRL_CHAR, NULL_CHAR); // Mask Control char for browser

        rsaProxy.elem("encryption", "cyp").val(cyp);
      });

      // Decryption
      rsaProxy.elem("decryption", "decrypt").click(function () {
        var key = JSON.parse(rsaProxy.elem("settings", "dkey").val());
        var cyp = rsaProxy.elem("decryption", "cyp").val();
        cyp  = cyp.replace(NULL_CHAR, CTRL_CHAR); // Mask Control char for browser
        var msg = RSAUtil.decrypt(key,cyp)

        rsaProxy.elem("decryption", "msg").val(msg);
      });

      // Information toggles
      $(".toggle").click(function () {
        $(this).next(".info").toggle();
      });

      // Retrieve keys from local storage
      $(".retrieve").click(function () {
        try {
          keys = JSON.parse(localStorage.getItem("rsa-keys"));

          rsaProxy.elem("settings", "ekey").val(JSON.stringify(keys.e));
          rsaProxy.elem("settings", "dkey").val(JSON.stringify(keys.d));
        } catch(e) {
          alert("Browser not compatible");
        }
      });

      // Initialize share buttons
      clipboard = new Clipboard('.share');
      clipboard.on('success', function(e) {
        original = $(e.trigger).text();

        $(e.trigger).text("Copied!");

        setTimeout(function () {
          $(e.trigger).text(original);
        }, 1000);
      });
    });
  </script>
</body>
</html>
